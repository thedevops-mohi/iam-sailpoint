{
    "name": "CustomAuthBeforeOperationRule",
    "description": "This rule is used by the  Web Services connector before performing any operation like testconnection, aggregation, etc.",
    "type": "WebServiceBeforeOperationRule",
    "signature": {
        "input": [
            {
                "name": "application",
                "description": "The application whose data file is being processed.",
                "type": null
            },
            {
                "name": "requestEndPoint",
                "description": "The current request information contain header, body, context url, method type, response attribute map,\n          successful response code\n        ",
                "type": null
            },
            {
                "name": "oldResponseMap",
                "description": "earlier response object ",
                "type": null
            },
            {
                "name": "restClient",
                "description": "REST Client Object",
                "type": null
            }
        ],
        "output": {
            "name": "EndPoint",
            "description": "Updated EndPoint Object",
            "type": null
        }
    },
    "source_code": {
        "version": "1.0",
        "script": "import java.util.HashMap;\nimport java.util.Map;\nimport java.util.List;\nimport java.util.ArrayList;\nimport connector.common.JsonUtil;\nimport sailpoint.connector.webservices.WebServicesClient;\nimport sailpoint.connector.webservices.EndPoint;\nimport com.google.gson.Gson;\nimport javax.ws.rs.core.MultivaluedHashMap;\nimport javax.ws.rs.core.MultivaluedMap;\nimport connector.common.JsonUtil;\nimport sailpoint.connector.webservices.WebServicesClient;\nimport sailpoint.connector.webservices.EndPoint;\nimport org.json.JSONObject; // For parsing JSON response\n\ntry {\n    log.error(\"Kiteworks: Entering Custom Auth\");\n\n    // --- 1. Define Authentication Parameters from Application Configuration ---\n    // These should be stored as attributes in your SailPoint Application definition.\n\n    Map formData = new HashMap();\n    String tokenUrl = \"https://secureshare.igmservices.com/oauth/token\";\n    \n    formData.put(\"client_id\", \"22a7136f-fbb5-5578-83ae-e67eee78eddf\");\n    formData.put(\"client_secret\", \"z4pk~qeiyYvsnbx\");\n    formData.put(\"grant_type\", \"password\");\n    formData.put(\"username\", \"scim-test@igmfinancial.com\");\n    formData.put(\"password\", \"Password4IGMSCIM!\");\n    \n    log.error(\"Kiteworks: After formData\");\n    WebServicesClient client = new WebServicesClient();\n    Map args = new HashMap();\n    args.put(WebServicesClient.ARG_URL, tokenUrl);\n    client.configure(args);\n\n    Map header = new HashMap();\n    header.put(\"Content-Type\", \"application/x-www-form-urlencoded\");\n\n    List allowedStatuses = new ArrayList();\n    allowedStatuses.add(\"2**\");\n\n    String response = client.executePost(tokenUrl, formData, header, allowedStatuses);\n\n    log.error(\"Kiteworks: Response is \" + response);\n     // --- 3. Parse the Response and Extract the New Access Token ---\n    JSONObject jsonResponse = new JSONObject(response);\n    String newAccessToken = jsonResponse.getString(\"access_token\");\n    String newRefreshToken = jsonResponse.getString(\"refresh_token\");\n\n    Map transientValues = (Map) application.getAttributeValue(\"transientValues\");\n    if (transientValues == null) {\n        transientValues = new HashMap();\n    }\n    // Passing values to AfterOperation Rule\n    transientValues.put(\"custom_refreshtoken\", newRefreshToken);\n    transientValues.put(\"custom_accesstoken\", newAccessToken);\n    application.setAttribute(\"transientValues\", transientValues);\n    \n    Map requestHeaders = requestEndPoint.getHeader();\n    requestHeaders.put(\"Authorization\", \"Bearer \" + newAccessToken);\n\n\n    log.error(\"Kiteworks: After transientValues\");\n    // Update the requestEndPoint object\n    requestEndPoint.setHeader(requestHeaders);\n\n} catch (Exception e) {\n    log.error(\"Kiteworks: Error in WebServicesBeforeOperationRule during token refresh: \" + e.getMessage());\n    throw e; // Re-throw the exception to stop the operation if auth fails\n}\n\nlog.error(\"Kiteworks: requestEndPoint is: \" + requestEndPoint);\nreturn requestEndPoint; // Return the modified endpoint for the main operation\n"
    },
    "attributes": {
        "sourceVersion": "1.0"
    },
    "id": "4074ef10c72e4c32a5884b8416d03265",
    "created": "2025-12-01T20:11:07.048Z",
    "modified": "2025-12-05T22:58:42.445Z"
}