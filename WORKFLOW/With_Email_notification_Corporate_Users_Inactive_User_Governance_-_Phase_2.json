{
    "version": 1,
    "var_self": {
        "type": "WORKFLOW",
        "id": "75f2f15d-b1ea-4de7-83be-6113e28f9d23",
        "name": "With Email notification Corporate Users Inactive User Governance - Phase 2"
    },
    "object": {
        "id": "75f2f15d-b1ea-4de7-83be-6113e28f9d23",
        "name": "With Email notification Corporate Users Inactive User Governance - Phase 2",
        "description": "",
        "created": "2025-07-29T19:40:46.65556157Z",
        "modified": "2025-08-01T13:54:26.629831695Z",
        "modifiedBy": {
            "type": "IDENTITY",
            "id": "1883596e385748c7bec4833a76bacad4",
            "name": "Khilan.Shah"
        },
        "definition": {
            "start": "HTTP Request",
            "steps": {
                "End Step - Success": {
                    "actionId": "sp:operator-success",
                    "displayName": "",
                    "type": "success"
                },
                "HTTP Request": {
                    "actionId": "sp:http",
                    "attributes": {
                        "authenticationType": "OAuth",
                        "jsonRequestBody": {
                            "indices": [
                                "identities"
                            ],
                            "query": {
                                "query": "(attributes.userType:\"employee\" OR attributes.userType:\"contractor\") AND (attributes.cloudLifecycleState:\"active\") AND (attributes.lastSignInDateType:[* TO now-50d])"
                            }
                        },
                        "method": "post",
                        "oAuthClientId": "0a330447168744da986026dd588c9975",
                        "oAuthClientSecret": "$.secrets.b9cbcf9a-0c32-4913-9268-eaed16f7dd51",
                        "oAuthCredentialLocation": "oAuthInHeader",
                        "oAuthTokenUrl": "https://igmfinancial-dev.api.identitynow.com/oauth/token",
                        "requestContentType": "json",
                        "requestHeaders": {
                            "Content-Type": "application/json"
                        },
                        "url": "https://igmfinancial-dev.api.identitynow.com/v2025/search"
                    },
                    "description": "Get the list of identities whose last sign in date more than 45 days ago.",
                    "displayName": "",
                    "nextStep": "Loop",
                    "type": "action",
                    "versionNumber": 2
                },
                "Loop": {
                    "actionId": "sp:loop:iterator",
                    "attributes": {
                        "input.$": "$.hTTPRequest.body",
                        "start": "Get Identity 1",
                        "steps": {
                            "Compare Strings": {
                                "actionId": "sp:compare-strings",
                                "choiceList": [
                                    {
                                        "comparator": "StringContains",
                                        "nextStep": "Get Accounts",
                                        "variableA.$": "$.getIdentity1.attributes.loaEndDate",
                                        "variableB": "None"
                                    }
                                ],
                                "defaultStep": "Get Accounts 1",
                                "description": "Verify if LOA End date set for identity.",
                                "displayName": "",
                                "type": "choice"
                            },
                            "Compare Timestamps": {
                                "actionId": "sp:compare-timestamps",
                                "choiceList": [
                                    {
                                        "comparator": "TimestampLessThanXDay",
                                        "nextStep": "HTTP Request 3",
                                        "variableA.$": "$.getIdentity1.attributes.loaEndDateType",
                                        "variableB": "7"
                                    }
                                ],
                                "defaultStep": "End Step - Success 1",
                                "description": "Check if LOA end date is in past for more than 7 days.",
                                "displayName": "Check LOA End Date",
                                "type": "choice"
                            },
                            "Define Variable": {
                                "actionId": "sp:define-variable",
                                "attributes": {
                                    "id": "sp:define-variable",
                                    "variables": [
                                        {
                                            "description": "",
                                            "name": "date",
                                            "transforms": [],
                                            "variableA.$": "$.getIdentity1.attributes.loaEndDateType"
                                        },
                                        {
                                            "description": "",
                                            "name": "currentdate",
                                            "transforms": [
                                                {
                                                    "id": "sp:transform:substring:string",
                                                    "input": {
                                                        "length": 10,
                                                        "start": 0
                                                    }
                                                },
                                                {
                                                    "id": "sp:transform:concatenate:string",
                                                    "input": {
                                                        "variableB": "T-01:00:00:000-00:00"
                                                    }
                                                }
                                            ],
                                            "variableA.$": "$.now()"
                                        }
                                    ]
                                },
                                "displayName": "",
                                "nextStep": "Compare Strings",
                                "type": "Mutation"
                            },
                            "Define Variable 1": {
                                "actionId": "sp:define-variable",
                                "attributes": {
                                    "id": "sp:define-variable",
                                    "variables": [
                                        {
                                            "description": "",
                                            "name": "snow",
                                            "transforms": [],
                                            "variableA.$": "$.getAccounts1.accounts[?(@.sourceName==\"ServiceNowAPI\")].id"
                                        }
                                    ]
                                },
                                "displayName": "",
                                "nextStep": "Compare Timestamps",
                                "type": "Mutation"
                            },
                            "Define Variable 2": {
                                "actionId": "sp:define-variable",
                                "attributes": {
                                    "id": "sp:define-variable",
                                    "variables": [
                                        {
                                            "description": "",
                                            "name": "snow",
                                            "transforms": [],
                                            "variableA.$": "$.getAccounts.accounts[?(@.sourceName==\"ServiceNowAPI\")].id"
                                        }
                                    ]
                                },
                                "displayName": "",
                                "nextStep": "HTTP Request 1",
                                "type": "Mutation"
                            },
                            "End Step - Success 1": {
                                "actionId": "sp:operator-success",
                                "displayName": "",
                                "type": "success"
                            },
                            "Get Accounts": {
                                "actionId": "sp:get-accounts",
                                "attributes": {
                                    "filterCriteria": "name",
                                    "getAccountsBy": "specificIdentity",
                                    "identity.$": "$.getIdentity1.id",
                                    "operator": "eq",
                                    "value": "ServiceNowAPI"
                                },
                                "description": "Get ServiceNowAPI source id",
                                "displayName": "",
                                "nextStep": "Define Variable 2",
                                "type": "action",
                                "versionNumber": 1
                            },
                            "Get Accounts 1": {
                                "actionId": "sp:get-accounts",
                                "attributes": {
                                    "filterCriteria": "name",
                                    "getAccountsBy": "specificIdentity",
                                    "identity.$": "$.getIdentity1.id",
                                    "operator": "eq",
                                    "value": "ServiceNowAPI"
                                },
                                "description": "Get ServiceNowAPI source id",
                                "displayName": "",
                                "nextStep": "Define Variable 1",
                                "type": "action",
                                "versionNumber": 1
                            },
                            "Get Identity": {
                                "actionId": "sp:get-identity",
                                "attributes": {
                                    "id.$": "$.loop.loopInput.manager.id"
                                },
                                "description": "Get Manager information",
                                "displayName": "Get Manager",
                                "nextStep": "Send Email",
                                "type": "action",
                                "versionNumber": 2
                            },
                            "Get Identity 1": {
                                "actionId": "sp:get-identity",
                                "attributes": {
                                    "id.$": "$.loop.loopInput.id"
                                },
                                "description": "Get information about each identity.",
                                "displayName": "",
                                "nextStep": "Define Variable",
                                "type": "action",
                                "versionNumber": 2
                            },
                            "HTTP Request 1": {
                                "actionId": "sp:http",
                                "attributes": {
                                    "authenticationType": "OAuth",
                                    "jsonPatchRequestBody": [
                                        {
                                            "op": "add",
                                            "path": "/attributes/loaStartDate",
                                            "value": "{{$.defineVariable.currentdate}}"
                                        }
                                    ],
                                    "jsonRequestBody": {
                                        "indices": [
                                            "identities"
                                        ],
                                        "query": {
                                            "query": "(attributes.userType:\"employee\" OR attributes.userType:\"contractor\") AND (attributes.cloudLifecycleState:\"active\") AND (attributes.lastSignInDateType:[* TO now-50d])"
                                        }
                                    },
                                    "method": "patch",
                                    "oAuthClientId": "0a330447168744da986026dd588c9975",
                                    "oAuthClientSecret": "$.secrets.abaaaed5-1075-43bf-ac08-1746f41c85f3",
                                    "oAuthCredentialLocation": "oAuthInHeader",
                                    "oAuthTokenUrl": "https://igmfinancial-dev.api.identitynow.com/oauth/token",
                                    "requestContentType": "json-patch+json",
                                    "requestHeaders": {
                                        "Content-Type": "application/json"
                                    },
                                    "url": "https://igmfinancial-dev.api.identitynow.com/v2025/accounts/{{$.defineVariable2.snow}}"
                                },
                                "description": "Get the list of identities whose last sign in date more than 45 days ago.",
                                "displayName": "",
                                "nextStep": "Verify Data Type",
                                "type": "action",
                                "versionNumber": 2
                            },
                            "HTTP Request 2": {
                                "actionId": "sp:http",
                                "attributes": {
                                    "authenticationType": "OAuth",
                                    "jsonPatchRequestBody": [
                                        {
                                            "op": "add",
                                            "path": "/attributes/loaStartDate",
                                            "value": "{{$.defineVariable.currentdate}}"
                                        }
                                    ],
                                    "jsonRequestBody": {
                                        "indices": [
                                            "identities"
                                        ],
                                        "query": {
                                            "query": "(attributes.userType:\"employee\" OR attributes.userType:\"contractor\") AND (attributes.cloudLifecycleState:\"active\") AND (attributes.lastSignInDateType:[* TO now-50d])"
                                        }
                                    },
                                    "method": "patch",
                                    "oAuthClientId": "0a330447168744da986026dd588c9975",
                                    "oAuthClientSecret": "$.secrets.c64dd486-02ed-4966-9db3-151c8754de49",
                                    "oAuthCredentialLocation": "oAuthInHeader",
                                    "oAuthTokenUrl": "https://igmfinancial-dev.api.identitynow.com/oauth/token",
                                    "requestContentType": "json-patch+json",
                                    "requestHeaders": {
                                        "Content-Type": "application/json"
                                    },
                                    "url": "https://igmfinancial-dev.api.identitynow.com/v2025/accounts/{{$.defineVariable1.snow}}"
                                },
                                "description": "Get the list of identities whose last sign in date more than 45 days ago.",
                                "displayName": "",
                                "nextStep": "Verify Data Type",
                                "type": "action",
                                "versionNumber": 2
                            },
                            "HTTP Request 3": {
                                "actionId": "sp:http",
                                "attributes": {
                                    "authenticationType": "OAuth",
                                    "jsonPatchRequestBody": [
                                        {
                                            "op": "remove",
                                            "path": "/attributes/loaEndDate"
                                        }
                                    ],
                                    "jsonRequestBody": {
                                        "indices": [
                                            "identities"
                                        ],
                                        "query": {
                                            "query": "(attributes.userType:\"employee\" OR attributes.userType:\"contractor\") AND (attributes.cloudLifecycleState:\"active\") AND (attributes.lastSignInDateType:[* TO now-50d])"
                                        }
                                    },
                                    "method": "patch",
                                    "oAuthClientId": "0a330447168744da986026dd588c9975",
                                    "oAuthClientSecret": "$.secrets.b8138f39-0b6e-4f11-878a-a46f1d46e8aa",
                                    "oAuthCredentialLocation": "oAuthInHeader",
                                    "oAuthTokenUrl": "https://igmfinancial-dev.api.identitynow.com/oauth/token",
                                    "requestContentType": "json-patch+json",
                                    "requestHeaders": {
                                        "Content-Type": "application/json"
                                    },
                                    "url": "https://igmfinancial-dev.api.identitynow.com/v2025/accounts/{{$.defineVariable1.snow}}"
                                },
                                "description": "Get the list of identities whose last sign in date more than 45 days ago.",
                                "displayName": "",
                                "nextStep": "HTTP Request 2",
                                "type": "action",
                                "versionNumber": 2
                            },
                            "Send Email": {
                                "actionId": "sp:send-email",
                                "attributes": {
                                    "body": "<p class=\"MsoNormal\">Dear&nbsp;${managerFirstName}<strong> </strong>${managerLastName},</p>\n<p class=\"MsoNormal\"><span style=\"font-size: 11.0pt; line-height: 107%; font-family: 'Aptos',sans-serif; mso-ascii-theme-font: minor-latin; mso-fareast-font-family: Aptos; mso-fareast-theme-font: minor-latin; mso-hansi-theme-font: minor-latin; mso-bidi-font-family: 'Times New Roman'; mso-bidi-theme-font: minor-bidi; mso-ansi-language: EN-CA; mso-fareast-language: EN-US; mso-bidi-language: AR-SA;\">The following user has not logged in for the past 45 days:</span></p>\n<p>Name<strong>:</strong>&nbsp;${firstName} ${lastName}</p>\n<p>Username<strong>:</strong>&nbsp;${sAMAccountName}</p>\n<p class=\"MsoNormal\">As a result, the user&rsquo;s account has been&nbsp;suspended<strong>,</strong>&nbsp;and all access has been&nbsp;disabled. The user&rsquo;s email address has also been&nbsp;restricted.</p>\n<p class=\"MsoNormal\">If reactivation of the account is required, please submit a&nbsp;ServiceNow ticket&nbsp;using the&nbsp;<a href=\"https://igmfinancial.service-now.com/snap?id=sc_cat_item&amp;sys_id=2aae9af7db6975d0520eae3b13961903&amp;sysparm_category=240d741d1b10e010f2110f6cdc4bcbaa\">Onboarding Request - Resource Centre</a>&nbsp;form and select the&nbsp;\"Return from temporary leave\"&nbsp;option.</p>\n<p class=\"MsoNormal\">For any further questions, please contact the&nbsp;IAM Operations team&nbsp;at&nbsp;<a href=\"mailto:iamops@igmfinancial.com\" target=\"_blank\" rel=\"noopener\">iamops@igmfinancial.com</a>.</p>\n<p class=\"MsoNormal\">Best regards,<br>IAM Operations Team</p>",
                                    "context": {
                                        "firstName.$": "$.getIdentity1.attributes.firstname",
                                        "lastName.$": "$.getIdentity1.attributes.lastname",
                                        "managerFirstName.$": "$.getIdentity.attributes.firstname",
                                        "managerLastName.$": "$.getIdentity.attributes.lastname",
                                        "sAMAccountName.$": "$.getIdentity1.attributes.samaccountname"
                                    },
                                    "recipientEmailList.$": "$.getIdentity.attributes.email",
                                    "subject": "User Account ${firstName} ${lastName} Suspended Due to Inactivity"
                                },
                                "description": "Send email to manager.",
                                "displayName": "",
                                "nextStep": "End Step - Success 1",
                                "type": "action",
                                "versionNumber": 2
                            },
                            "Verify Data Type": {
                                "actionId": "sp:compare-unary",
                                "choiceList": [
                                    {
                                        "comparator": "IsPresent",
                                        "nextStep": "Get Identity",
                                        "variableA.$": "$.loop.loopInput.manager"
                                    }
                                ],
                                "defaultStep": "End Step - Success 1",
                                "description": "Make sure manager exists",
                                "displayName": "Verify Manager Exists",
                                "type": "choice"
                            }
                        }
                    },
                    "displayName": "",
                    "nextStep": "End Step - Success",
                    "type": "action",
                    "versionNumber": 1
                }
            }
        },
        "enabled": false,
        "creator": {
            "type": "IDENTITY",
            "id": "1883596e385748c7bec4833a76bacad4",
            "name": "Khilan.Shah"
        },
        "owner": {
            "type": "IDENTITY",
            "id": "1883596e385748c7bec4833a76bacad4",
            "name": "Khilan.Shah"
        },
        "trigger": {
            "type": "SCHEDULED",
            "attributes": {
                "cronString": "0 9,10,11,12,13,14,15,21 * * *",
                "dailyTimes": [
                    "1969-12-31T15:00:00.000Z",
                    "1969-12-31T16:00:00.000Z",
                    "1969-12-31T17:00:00.000Z",
                    "1969-12-31T18:00:00.000Z",
                    "1969-12-31T19:00:00.000Z",
                    "1969-12-31T20:00:00.000Z",
                    "1969-12-31T21:00:00.000Z",
                    "1970-01-01T03:00:00.000Z"
                ],
                "frequency": "daily",
                "id": "idn:cron-schedule",
                "timeZone": "America/Winnipeg"
            }
        }
    }
}